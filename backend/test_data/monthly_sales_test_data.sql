-- 月次売上管理のテストデータ
-- このファイルは開発・デバッグ用のサンプルデータを提供します

-- 前提: stores テーブルに店舗データが存在すること
-- 店舗IDは実際の環境に合わせて調整してください

-- テストデータ用の変数定義（店舗IDを実際の値に置き換えてください）
-- 例: SELECT id FROM stores WHERE name = '温野菜 富山店' LIMIT 1;

-- 2025年1月の月次売上データ（サンプル店舗用）
DO $$
DECLARE
    v_store_id UUID;
    v_user_id UUID;
BEGIN
    -- 最初の店舗IDを取得（実際の環境に合わせて調整）
    SELECT id INTO v_store_id FROM stores ORDER BY created_at LIMIT 1;

    -- 最初のユーザーIDを取得（作成者として使用）
    SELECT id INTO v_user_id FROM employees WHERE role = 'super_admin' LIMIT 1;

    -- 既存データがあれば削除
    DELETE FROM sales_data WHERE store_id = v_store_id AND year = 2025 AND month = 1;

    -- 2025年1月のテストデータを挿入
    INSERT INTO sales_data (
        store_id,
        year,
        month,
        daily_data,
        created_by,
        updated_by,
        created_at,
        updated_at
    ) VALUES (
        v_store_id,
        2025,
        1,
        jsonb_build_object(
            -- 基本情報
            '日付', '2025-01-01',
            '曜日', '水',

            -- 売上・目標関連
            '売上目標', 500000,
            '目標累計', 500000,
            '対目標比', 98.5,
            '前年比', 105.2,
            'EDW前年比', 108.3,
            'OHB前年比', 102.1,
            '集計担当者', '山田太郎',

            -- 店舗純売上
            '店舗純売上', 492500,
            '店舗純売上累計', 492500,

            -- EDW純売上
            'EDW純売上', 350000,
            'EDW純売上累計', 350000,

            -- OHB純売上
            'OHB純売上', 142500,
            'Uber', 28000,
            'OHB純売上累計', 142500,

            -- 客数・組数
            '組数（計）', 125,
            '客数（計）', 280,
            '組単価', 3940,
            '客単価', 1759,

            -- 人時・人件費
            '社員時間', 48,
            'AS時間', 72,
            '人時売上高', 4104,
            '人件費額', 145000,
            '人件費率', 29.4,

            -- L/D売上
            'L：売上', 280000,
            'D：売上', 212500,
            'L：客数', 160,
            'D：客数', 120,
            'L：組数', 70,
            'D：組数', 55,
            'L：単価', 1750,
            'D：単価', 1771,

            -- その他売上データ
            '売上', 492500,
            '客数', 280,
            '組数', 125,

            -- VOID・過不足
            'VOID件数', 2,
            'VOID金額', 3500,
            '売上金過不足', -500,

            -- 総時間・生産性
            '総時間社員込', 120,
            'EDW総時間', 75,
            'OHB総時間', 45,
            'EDW生産性', 4667,
            'OHB生産性', 3167,
            '総生産性', 4104,

            -- 利益関連（月次集計用）
            '償却前利益額（実績）', 85000,
            '償却前利益額（見込）', 80000,
            '償却前利益差異（実績）-（見込）', 5000,
            '償却前利益額（目標）', 82000,
            '償却前利益額（前年）', 78000,
            '利益率', 17.3,

            -- 人事・労務（月次集計用）
            '入店人数', 3,
            '退職人数', 1,
            '在籍人数', 28,
            '代行人数', 0,
            '社員・AS総時間', 120,
            'スポットワーク総時間', 15,
            '店舗総勤務時間', 135,
            '生産性実績', 3648,
            'AS・社員人件費率', 29.4,

            -- 運営関連
            'クレーム件数', 1,
            'クレーム内容', '料理の温度が低い',
            'レジ金月間誤差', -500,

            -- 在庫・原価
            '前月末棚卸し額①', 280000,
            '当月食材発注金額②', 165000,
            '当月末棚卸し額③', 295000,
            '当月末食材在庫比率', 59.9,
            '実原価率（①＋②－③）', 30.5,
            '発注金額原価率', 33.5,
            '理論or目標原価率', 32.0,
            '当月食材発注適正額（予算）', 157600,
            '当月食材発注金額差異（実績-予算）', 7400,
            '当月食材発注金額乖離率', 4.7,
            'ベーカリーロス比率：対個数比', 2.5,
            'ベーカリーロス比率：対売上比', 1.8,
            'FL比率', 59.9,

            -- マーケティング
            'ファンくるスコア', 85,
            'Google口コミ総件数', 152,
            'Google口コミ純増', 5,
            'インスタフォロー累計：件', 1250,
            'インスタフォロー増減：件', 15,
            '投稿数単月：件', 12,
            'チラシ枚数', 500,

            -- その他の売上データ
            'TOドリ売上', 45000,
            '物販売上', 8500,
            '焙煎豆売上', 12000
        ),
        v_user_id,
        v_user_id,
        NOW(),
        NOW()
    );

    RAISE NOTICE 'テストデータを正常に挿入しました (店舗ID: %, 2025年1月)', v_store_id;

EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'エラーが発生しました: %', SQLERRM;
        RAISE NOTICE '店舗データが存在するか、またはデータベース接続を確認してください。';
END $$;

-- 挿入されたデータの確認
SELECT
    id,
    store_id,
    year,
    month,
    jsonb_object_keys(daily_data) as field_name,
    created_at
FROM sales_data
WHERE year = 2025 AND month = 1
ORDER BY created_at DESC
LIMIT 5;
