# デバッグレポート

**作成日**: 2025年12月
**対象**: 全機能デバッグ（一般ユーザー、管理者、スーパー管理者）

## 1. テスト環境

### 1.1 テストユーザー
以下のテストユーザーが作成されました：

- **一般ユーザー (user)**:
  - `test_user_1` (パスワード: `test123`)
  - `test_user_2` (パスワード: `test123`)
  - `test_user_3` (パスワード: `test123`)

- **管理者 (admin)**:
  - `test_admin_1` (パスワード: `admin123`)
  - `test_admin_2` (パスワード: `admin123`)

- **スーパー管理者 (super_admin)**:
  - `test_super_admin` (パスワード: `super123`)

### 1.2 テストデータ
以下のテストデータが作成されました：

- **シフトデータ**: 11月後半、12月前半、12月後半の期間データと提出データ
- **売上データ**: 2025年11月、12月の日次データ
- **取引先データ**: 3件の取引先（定期支払い、特定月支払い、不定期支払い）
- **支払いデータ**: 11月、12月の支払いデータ
- **P&Lデータ**: 2025年11月、12月のP&Lデータ

## 2. コードレビューで発見された潜在的な問題

### 2.1 認証・権限システム

#### 問題点1: ログインページの勤怠番号バリデーション
**ファイル**: `next-app/src/app/login/page.tsx`
**問題**: 勤怠番号の入力フィールドが4桁固定になっているが、実際のデータベースでは`VARCHAR(50)`で、テストユーザーは`test_user_1`のような文字列IDを使用している。
**影響**: テストユーザーでログインできない可能性がある。
**優先度**: 高

#### 問題点2: ログイン後のリダイレクトロジック
**ファイル**: `next-app/src/app/login/page.tsx` (line 60)
**問題**: `isAdmin()`関数を使用しているが、`super_admin`も`admin`として扱われるため、リダイレクトは正しく動作するはず。
**確認事項**: 実際の動作確認が必要。

#### 問題点3: 権限チェックの一貫性
**ファイル**: `next-app/src/stores/authStore.ts`
**問題**: `hasPermission()`関数は階層的な権限チェックを実装しているが、一部のページコンポーネントでは直接`user.role`をチェックしている。
**影響**: 権限チェックのロジックが分散しているため、メンテナンスが困難。
**優先度**: 中

### 2.2 一般ユーザー機能

#### 問題点4: シフト提出ページの期間選択ロジック
**ファイル**: `next-app/src/app/employee/shifts/page.tsx` (line 42-75)
**問題**: `useEffect`内で`periodId`が`undefined`に固定されている。これは意図的な実装か確認が必要。
**確認事項**: 期間選択の動作確認が必要。

### 2.3 管理者機能

#### 問題点5: シフト管理ページの店舗自動選択
**ファイル**: `next-app/src/app/admin/shifts/page.tsx` (line 150-170)
**問題**: 店舗の自動選択ロジックが実装されているが、`isHydrated`の状態管理に依存している。
**確認事項**: 初回ロード時の動作確認が必要。

#### 問題点6: 売上管理ページの店舗選択
**ファイル**: `next-app/src/app/admin/sales-management/page.tsx` (line 70-91)
**問題**: 店舗選択のロジックが複雑で、`user.storeId`と`stores`の状態に依存している。
**確認事項**: 店舗選択の動作確認が必要。

#### 問題点7: 取引先管理の`specificMonths`処理
**ファイル**: `next-app/src/app/admin/companies/page.tsx` (line 413-418)
**問題**: `specificMonths`の型変換が複数箇所で行われている。データベースから取得した配列を数値配列に変換する処理が重複している。
**優先度**: 中

### 2.4 APIエンドポイント

#### 問題点8: 認証ミドルウェアのエラーハンドリング
**ファイル**: `backend/src/index.ts` (line 235-251)
**問題**: `authenticateToken`関数で401と403の両方が返される可能性があるが、エラーメッセージが含まれていない。
**影響**: フロントエンドでエラーの原因を特定しにくい。
**優先度**: 中

#### 問題点9: エラーレスポンスの一貫性
**問題**: 一部のAPIエンドポイントでエラーレスポンスの形式が統一されていない。
**影響**: フロントエンドのエラーハンドリングが複雑になる。
**優先度**: 中

### 2.5 データ整合性

#### 問題点10: 外部キー制約の動作確認
**問題**: 取引先削除時の支払いデータチェックが実装されているが、実際の動作確認が必要。
**ファイル**: `backend/src/index.ts` (DELETE /api/companies/:id)
**確認事項**: 関連データがある場合の削除エラーの動作確認が必要。

## 3. 実際のブラウザテストが必要な項目

### 3.1 認証・権限システム
1. 各権限レベルでのログイン動作確認
2. ログイン後のリダイレクト動作確認
3. 権限のないページへのアクセス時の動作確認
4. ログアウト機能の動作確認
5. セッションタイムアウトの動作確認

### 3.2 一般ユーザー機能
1. ダッシュボードの表示確認
2. シフト提出機能の動作確認
3. シフト提出期限の表示確認
4. 提出済みシフトの確認機能

### 3.3 管理者機能
1. 各管理ページへのアクセス確認
2. データの表示・編集・削除機能
3. Excel出力機能（特に15日、30日、31日の処理）
4. 店舗選択の動作確認
5. 権限制御の動作確認

### 3.4 スーパー管理者機能
1. 全機能へのアクセス確認
2. 業態管理機能
3. 全店舗管理機能
4. 管理者追加機能
5. 売上管理表示項目設定機能

### 3.5 APIエンドポイント
1. 各APIエンドポイントの動作確認
2. エラーハンドリングの動作確認
3. 認証トークンの検証確認
4. 権限チェックの動作確認

### 3.6 UI/UX
1. レスポンシブデザインの確認
2. ローディング状態の表示確認
3. エラーメッセージの表示確認
4. フォームバリデーションの動作確認

## 4. 推奨される修正

### 4.1 即座に修正が必要（クリティカル）
1. **ログインページの勤怠番号バリデーション**: 4桁固定のバリデーションを緩和するか、テストユーザーのID形式を変更する。

### 4.2 早急に修正が必要（高）
1. **権限チェックの一貫性**: すべてのページコンポーネントで`hasPermission()`関数を使用するように統一する。
2. **エラーレスポンスの統一**: APIエンドポイントのエラーレスポンス形式を統一する。

### 4.3 修正推奨（中）
1. **`specificMonths`の処理**: 型変換ロジックを1箇所に集約する。
2. **認証ミドルウェアのエラーハンドリング**: エラーメッセージを含むレスポンスを返すように改善する。

## 5. 次のステップ

1. 実際のブラウザテストを実行し、上記の「実際のブラウザテストが必要な項目」を確認する。
2. 発見された問題を優先度順に修正する。
3. 修正後の再テストを実行する。
4. デバッグチェックリストを更新し、完了した項目にチェックを入れる。

## 6. テスト実行手順

1. ブラウザの開発者ツールを開く（コンソール、ネットワークタブ）
2. 各権限レベルでログイン
3. 各機能ページにアクセス
4. 各機能の操作を実行
5. エラー・警告を記録
6. 期待される動作と実際の動作を比較
7. 問題点をリスト化

## 7. 注意事項

- テストユーザーのパスワードは本番環境では変更する必要があります。
- テストデータは本番環境では削除する必要があります。
- ブラウザのキャッシュをクリアしてからテストを実行してください。

