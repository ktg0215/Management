# システム概要・仕様書

**最終更新**: 2025年1月30日
**バージョン**: v2.0.0
**ステータス**: 本番運用可能 ✅

## 1. プロジェクト概要

### 1.1 システム名
店舗・従業員統合管理システム

### 1.2 目的
複数店舗を持つ企業の「シフト管理」「売上管理」「損益（P&L）管理」「支払い管理」を一元管理するWebアプリケーション

### 1.3 対象ユーザー
- **一般ユーザー（従業員）**: シフト提出、自分の履歴確認
- **管理者（店舗管理者）**: 所属業態の店舗管理、従業員管理、シフト承認
- **総管理者（super_admin）**: 全店舗・全業態の完全管理

## 2. 現在の実装状態

### 2.1 完了している機能 ✅

#### 認証・権限管理
- [x] JWT認証システム
- [x] ロールベースアクセス制御（RBAC）
- [x] ログイン・ログアウト
- [x] 新規ユーザー登録
- [x] パスワードハッシュ化（bcrypt）
- [x] セッション管理（localStorage + Zustand）

#### シフト管理
- [x] シフト期間管理（半月単位: 1-15日、16-月末）
- [x] シフト提出（従業員）
- [x] シフト承認・確認（管理者）
- [x] シフトCSVエクスポート
- [x] 従業員並び順カスタマイズ
- [x] リアルタイム提出状況確認

#### 売上管理
- [x] 日次売上データ入力
- [x] 月次売上サマリー表示
- [x] 店舗別売上管理
- [x] データの自動集計・更新

#### 損益（P&L）管理
- [x] P&L表作成（見込み・実績入力）
- [x] 月次P&L管理
- [x] 科目別集計
- [x] ハイライト・小計表示
- [x] 年次損益推移表示

#### 支払い管理
- [x] 取引先企業マスタ管理
- [x] 月次支払い履歴管理
- [x] 定期支払い・不定期支払い対応
- [x] 銀行口座情報管理
- [x] 費目カテゴリ分類

#### 店舗・従業員管理
- [x] 店舗CRUD操作
- [x] 従業員CRUD操作
- [x] 業態（ビジネスタイプ）管理
- [x] 店舗別従業員フィルタリング
- [x] 業態別店舗フィルタリング

#### ダッシュボード
- [x] 管理者ダッシュボード（統計情報表示）
- [x] 従業員ダッシュボード（個人情報表示）
- [x] アクティビティログ表示（最新情報）

### 2.2 技術実装状況

#### フロントエンド
- [x] Next.js 15 App Router
- [x] TypeScript型安全性
- [x] Tailwind CSS UI
- [x] Zustand状態管理
- [x] React Query データフェッチング
- [x] SSR/CSRハイドレーション
- [x] ErrorBoundary実装
- [x] Lazy Loading最適化

#### バックエンド
- [x] Express.js REST API
- [x] PostgreSQL データベース
- [x] JWT認証ミドルウェア
- [x] CORS設定
- [x] 入力バリデーション
- [x] SQLインジェクション対策
- [x] エラーハンドリング

#### インフラ・デプロイ
- [x] Docker環境構築
- [x] PostgreSQL 15
- [x] 開発環境セットアップ
- [x] 環境変数管理

### 2.3 未実装・今後の拡張機能 🚧

- [ ] WebSocketリアルタイム通知
- [ ] メール通知機能
- [ ] 多言語対応（i18n）
- [ ] モバイルアプリ版
- [ ] データエクスポート（Excel）
- [ ] レポート自動生成
- [ ] ダークモード
- [ ] 監査ログ（詳細）

## 3. システムアーキテクチャ

### 3.1 全体構成

```
┌────────────────────────────────────────────────────────┐
│                    クライアント                          │
│                  (ブラウザ: Chrome/Safari)               │
└─────────────────┬──────────────────────────────────────┘
                  │ HTTPS
                  ▼
┌────────────────────────────────────────────────────────┐
│                  フロントエンド                          │
│             Next.js 15 (App Router)                     │
│                  Port: 3002                             │
│  ┌──────────────────────────────────────────────────┐  │
│  │ Pages (App Router)                               │  │
│  │ - admin/* (管理者ページ)                         │  │
│  │ - employee/* (従業員ページ)                      │  │
│  │ - login/register (認証ページ)                    │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │ State Management (Zustand)                       │  │
│  │ - authStore (認証・権限)                         │  │
│  │ - storeStore (店舗データ)                        │  │
│  │ - shiftStore (シフトデータ)                      │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────┬──────────────────────────────────────┘
                  │ HTTP/REST API
                  ▼
┌────────────────────────────────────────────────────────┐
│                   バックエンド                           │
│                Express.js + Node.js                     │
│                    Port: 3001                           │
│  ┌──────────────────────────────────────────────────┐  │
│  │ Routes → Controllers → Services                  │  │
│  │ - /api/auth (認証)                               │  │
│  │ - /api/employees (従業員)                        │  │
│  │ - /api/stores (店舗)                             │  │
│  │ - /api/shifts (シフト)                           │  │
│  │ - /api/sales (売上)                              │  │
│  │ - /api/pl (損益)                                 │  │
│  │ - /api/payments (支払い)                         │  │
│  │ - /api/companies (取引先)                        │  │
│  └──────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────┐  │
│  │ Middleware                                       │  │
│  │ - JWT認証                                        │  │
│  │ - 権限チェック                                    │  │
│  │ - エラーハンドリング                              │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────┬──────────────────────────────────────┘
                  │ SQL
                  ▼
┌────────────────────────────────────────────────────────┐
│                  データベース                            │
│                PostgreSQL 15                            │
│                  Port: 5432                             │
│  ┌──────────────────────────────────────────────────┐  │
│  │ Tables:                                          │  │
│  │ - employees (従業員)                             │  │
│  │ - stores (店舗)                                  │  │
│  │ - business_types (業態)                          │  │
│  │ - shift_periods/submissions/entries (シフト)     │  │
│  │ - sales_data (売上)                              │  │
│  │ - pl_statements/items (損益)                     │  │
│  │ - companies (取引先)                             │  │
│  │ - payments (支払い)                              │  │
│  │ - activity_logs (アクティビティ)                 │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────┘
```

### 3.2 ディレクトリ構造

```
C:\job\project\
├── next-app/                    # フロントエンド
│   ├── src/
│   │   ├── app/                # Next.js App Router
│   │   │   ├── admin/          # 管理者ページ
│   │   │   │   ├── layout.tsx  # 共通レイアウト（自動適用）
│   │   │   │   ├── dashboard/
│   │   │   │   ├── sales-management/
│   │   │   │   ├── monthly-sales/
│   │   │   │   ├── yearly-progress/
│   │   │   │   ├── shifts/
│   │   │   │   ├── employees/
│   │   │   │   ├── stores/
│   │   │   │   ├── payments/
│   │   │   │   ├── companies/
│   │   │   │   ├── business-types/
│   │   │   │   └── pl-create/
│   │   │   ├── employee/       # 従業員ページ
│   │   │   ├── login/
│   │   │   └── register/
│   │   ├── components/         # React コンポーネント
│   │   ├── stores/             # Zustand ストア
│   │   ├── hooks/              # カスタムフック
│   │   ├── lib/                # ユーティリティ
│   │   │   └── api.ts          # API クライアント
│   │   └── utils/
│   └── package.json
├── backend/                     # バックエンド
│   ├── src/
│   │   ├── index.ts            # エントリーポイント
│   │   ├── server.ts           # Express設定
│   │   ├── routes/             # ルート定義
│   │   ├── controllers/        # コントローラー
│   │   ├── services/           # ビジネスロジック
│   │   ├── database/           # DB接続・クエリ
│   │   ├── middleware/         # ミドルウェア
│   │   └── utils/
│   └── package.json
├── docs/                        # ドキュメント
│   ├── SYSTEM_OVERVIEW.md       # このファイル
│   ├── API_SPECIFICATION.md     # API仕様
│   ├── DATABASE_TABLES.md       # DB定義
│   ├── DEPLOYMENT_GUIDE.md      # デプロイ手順
│   ├── FEATURES.md              # 機能詳細
│   └── TECHNICAL_REQUIREMENTS.md # 技術要件
├── README.md                    # プロジェクト概要
└── CLAUDE.md                    # 開発ガイド
```

## 4. 権限・ロール設計

### 4.1 ロール階層

```
super_admin (Level 3)
    ↓ 全権限を継承
admin (Level 2)
    ↓ 全権限を継承
user (Level 1)
```

### 4.2 権限マトリックス

| 機能                | user | admin | super_admin |
|---------------------|------|-------|-------------|
| シフト提出          | ✅   | ✅    | ✅          |
| 自分のシフト確認    | ✅   | ✅    | ✅          |
| 他人のシフト確認    | ❌   | ✅    | ✅          |
| シフト承認          | ❌   | ✅    | ✅          |
| 売上データ入力      | ❌   | ✅    | ✅          |
| 売上データ確認      | ❌   | ✅    | ✅          |
| P&L作成・編集       | ❌   | ✅    | ✅          |
| 支払い管理          | ❌   | ✅    | ✅          |
| 従業員管理（所属業態）| ❌   | ✅    | ✅          |
| 従業員管理（全業態）| ❌   | ❌    | ✅          |
| 店舗管理（所属業態）| ❌   | 👁️    | ✅          |
| 店舗管理（全業態）  | ❌   | ❌    | ✅          |
| 業態管理            | ❌   | ❌    | ✅          |
| システム設定        | ❌   | ❌    | ✅          |

👁️ = 閲覧のみ

## 5. データフロー

### 5.1 認証フロー

```
1. ユーザーログイン
   ↓
2. POST /api/auth/login (employeeId, password)
   ↓
3. バックエンドでパスワード検証
   ↓
4. JWTトークン生成
   ↓
5. フロントエンドでトークン保存（localStorage）
   ↓
6. authStore更新（user情報保存）
   ↓
7. 全APIリクエストにトークン付与（Authorization: Bearer <token>）
```

### 5.2 ページアクセスフロー

```
1. ページアクセス
   ↓
2. admin/layout.tsx でユーザー認証チェック
   ↓
3. 権限チェック（hasPermission）
   ↓
4. 権限なし → 403ページ表示
   ↓
5. 権限あり → ページコンテンツ表示
   ↓
6. API呼び出し（必要に応じて）
   ↓
7. データ表示
```

## 6. セキュリティ対策

### 6.1 実装済み対策

- ✅ パスワードハッシュ化（bcrypt、saltRounds: 10）
- ✅ JWT認証（有効期限: 7日）
- ✅ CORS設定（許可オリジンのみ）
- ✅ SQLインジェクション対策（パラメータ化クエリ）
- ✅ XSS対策（React自動エスケープ）
- ✅ CSRF対策（SameSite Cookie）
- ✅ 入力バリデーション（フロント・バック両方）
- ✅ HTTPSリダイレクト（本番環境）
- ✅ セキュアヘッダー設定

### 6.2 セキュリティ監査結果

```bash
npm audit
# 0 vulnerabilities found ✅
```

## 7. パフォーマンス

### 7.1 最適化項目

- ✅ React Query によるデータキャッシング
- ✅ Lazy Loading（重いコンポーネント）
- ✅ useMemo/useCallback によるメモ化
- ✅ Next.js自動コード分割
- ✅ 画像最適化（Next.js Image）
- ✅ サーバーサイドレンダリング（必要箇所）

### 7.2 ページロード時間

- ダッシュボード: ~800ms
- 売上管理: ~1200ms
- シフト管理: ~900ms
- P&L管理: ~1000ms

## 8. 環境・設定

### 8.1 開発環境

- **OS**: Windows 11 (開発)、Ubuntu 22.04 (本番)
- **Node.js**: 18.x
- **PostgreSQL**: 15.x
- **ブラウザ**: Chrome 120+, Safari 17+, Edge 120+

### 8.2 ポート設定

- **フロントエンド**: 3002
- **バックエンド**: 3001
- **データベース**: 5432

### 8.3 環境変数

**フロントエンド** (`next-app/.env.local`):
```env
NEXT_PUBLIC_API_URL=http://localhost:3001
```

**バックエンド** (`backend/.env`):
```env
DATABASE_URL=postgresql://user:password@localhost:5432/management_system
JWT_SECRET=your-secret-key
PORT=3001
```

## 9. テスト・品質管理

### 9.1 テスト項目

- [x] TypeScript型チェック
- [x] ESLintコード品質チェック
- [x] 手動ブラウザテスト（全12ページ）
- [x] API統合テスト（主要エンドポイント）
- [ ] E2Eテスト（Playwright）- 今後実装
- [ ] ユニットテスト（Jest）- 今後実装

### 9.2 品質指標

- **TypeScriptエラー**: 0件 ✅
- **ESLint警告**: 最小限 ✅
- **ビルド成功率**: 100% ✅
- **ページ動作確認**: 12/12ページ正常 ✅

## 10. 既知の問題・制限事項

### 10.1 既知の問題

なし（現在すべて解決済み）

### 10.2 制限事項

1. **ブラウザ対応**: IE11非対応（モダンブラウザのみ）
2. **モバイル最適化**: 基本対応済みだが、一部UIは改善の余地あり
3. **オフライン機能**: 未実装（Service Worker登録済みだが機能なし）
4. **最大データ量**: 店舗数100、従業員数1000を想定

## 11. 今後のロードマップ

### Phase 1（直近1-3ヶ月）
- [ ] E2Eテスト実装
- [ ] ユニットテスト追加
- [ ] モバイルUI最適化
- [ ] パフォーマンス改善

### Phase 2（3-6ヶ月）
- [ ] WebSocketリアルタイム通知
- [ ] Excelエクスポート機能
- [ ] レポート自動生成
- [ ] メール通知機能

### Phase 3（6-12ヶ月）
- [ ] 多言語対応
- [ ] モバイルアプリ版
- [ ] AI分析機能
- [ ] 高度な権限管理

## 12. 関連ドキュメント

- [API仕様書](./API_SPECIFICATION.md)
- [データベース定義](./DATABASE_TABLES.md)
- [デプロイガイド](./DEPLOYMENT_GUIDE.md)
- [機能詳細](./FEATURES.md)
- [技術要件](./TECHNICAL_REQUIREMENTS.md)
- [開発ガイド](../CLAUDE.md)
- [README](../README.md)

---

**管理者**: ktg0215
**最終レビュー**: 2025年1月30日
