# 機能詳細仕様書

**最終更新**: 2025年1月30日

## 目次

1. [認証・ユーザー管理](#1-認証ユーザー管理)
2. [シフト管理](#2-シフト管理)
3. [売上管理](#3-売上管理)
4. [損益（P&L）管理](#4-損益pl管理)
5. [支払い管理](#5-支払い管理)
6. [店舗管理](#6-店舗管理)
7. [従業員管理](#7-従業員管理)
8. [ダッシュボード](#8-ダッシュボード)
9. [取引先管理](#9-取引先管理)
10. [業態管理](#10-業態管理)

---

## 1. 認証・ユーザー管理

### 1.1 ログイン機能

**ページ**: `/login`

**機能概要**:
- 従業員IDとパスワードで認証
- JWTトークン発行
- ロールに応じたリダイレクト

**入力項目**:
- 従業員ID（必須）
- パスワード（必須）

**処理フロー**:
1. 認証情報を`POST /api/auth/login`に送信
2. サーバーでパスワード検証（bcrypt）
3. JWTトークン生成（有効期限: 7日間）
4. トークンとユーザー情報をクライアントに返却
5. localStorageに保存
6. authStore更新
7. ロール別リダイレクト:
   - `super_admin`, `admin` → `/admin/dashboard`
   - `user` → `/employee/dashboard`

**エラーハンドリング**:
- 認証失敗時: エラーメッセージ表示
- ネットワークエラー: 再試行可能

### 1.2 新規登録機能

**ページ**: `/register`

**機能概要**:
- 新規ユーザーアカウント作成
- 初回登録時のみ利用可能（既存管理者がいる場合は無効）

**入力項目**:
- 従業員ID（必須、ユニーク）
- ニックネーム（必須）
- フルネーム（必須）
- 所属店舗（選択）
- パスワード（必須、8文字以上）

**制限事項**:
- 既存管理者がいる場合は登録不可
- 初回登録時のみ自動的に`super_admin`権限付与

### 1.3 ログアウト機能

**機能概要**:
- セッション終了
- トークン削除
- ログイン画面にリダイレクト

**処理フロー**:
1. `POST /api/auth/logout`呼び出し
2. localStorageからトークン削除
3. authStoreリセット
4. `/login`にリダイレクト

### 1.4 権限管理

**ロール階層**:
```
super_admin (Level 3)
  ├─ 全業態・全店舗管理
  ├─ 全従業員管理
  ├─ システム設定変更
  └─ 管理者アカウント作成

admin (Level 2)
  ├─ 所属業態の全店舗閲覧
  ├─ 所属店舗の管理
  ├─ 所属業態の従業員管理
  └─ シフト・売上・P&L管理

user (Level 1)
  ├─ 自分のシフト提出
  ├─ 自分の履歴確認
  └─ プロフィール編集
```

---

## 2. シフト管理

### 2.1 シフト提出（従業員）

**ページ**: `/employee/shift-submission`

**機能概要**:
- 半月単位でシフト希望を提出
- 日付ごとに出勤時間・退勤時間を入力
- 休日設定可能

**シフト期間**:
- 前半: 1日〜15日
- 後半: 16日〜月末

**入力方法**:
1. 年月・期間を選択
2. カレンダー表示
3. 各日付をクリックして時間入力
4. 休日チェックボックスで休日設定
5. 一括保存または日ごと保存

**提出期限**:
- 前半: 前月20日まで
- 後半: 当月5日まで

**ステータス**:
- 下書き: 提出前の編集可能状態
- 提出済み: 管理者が確認可能

### 2.2 シフト承認・管理（管理者）

**ページ**: `/admin/shifts`

**機能概要**:
- 従業員のシフト提出状況確認
- シフトCSV出力
- 従業員並び順カスタマイズ

**表示情報**:
- 提出状況サマリー:
  - 全従業員数
  - 提出済み人数・割合
  - 未提出人数
  - 提出期限
- 従業員一覧:
  - 勤怠番号
  - 氏名（ニックネーム）
  - 提出ステータス（提出済み/未提出）

**詳細表示**:
- 従業員名をクリックで展開
- 日付ごとの出勤・退勤時間表示
- 休日フラグ表示

**CSV出力機能**:
- ボタンクリックでCSVダウンロード
- ファイル名: `シフト表_{店舗名}_{年}年{月}月{前半/後半}.csv`
- 内容: 従業員名、各日の出勤・退勤時間

**並び順設定**:
- モーダルウィンドウで従業員順序変更
- 上下ボタンで並び替え
- 設定はlocalStorageに保存（店舗別）

### 2.3 シフト履歴確認

**ページ**: `/employee/shift-history`

**機能概要**:
- 過去のシフト提出履歴確認
- 月別・期間別フィルタリング

---

## 3. 売上管理

### 3.1 日次売上入力

**ページ**: `/admin/sales-management`

**機能概要**:
- 日ごとの売上データ入力
- 月次カレンダー表示
- リアルタイム集計

**入力項目（日ごと）**:
- 店舗純売上（税抜）
- クレジットカード売上
- 現金売上
- 電子マネー売上
- QRコード決済売上
- その他売上
- 各種経費項目

**表示形式**:
- カレンダー形式
- データ入力済みの日は背景色変更
- 当日は強調表示

**操作**:
- 日付クリックで入力フォーム表示
- 保存ボタンで即時保存
- キャンセルボタンで編集中止

**集計表示**:
- 月次合計自動計算
- 前月比較
- 日平均売上

### 3.2 月次売上サマリー

**ページ**: `/admin/monthly-sales`

**機能概要**:
- 月別売上推移表示
- グラフ表示
- 前年同月比較

**表示項目**:
- 月別売上推移（12ヶ月）
- カテゴリ別内訳
- 前年同月比
- 達成率

---

## 4. 損益（P&L）管理

### 4.1 P&L表作成

**ページ**: `/admin/pl-create`

**機能概要**:
- 月次損益計算書作成
- 見込み・実績の入力
- 科目別集計

**科目構成**:
- 売上高
- 変動費
  - バイト給与
  - 原価
  - カードポイント
  - その他変動費
- 固定費
  - 正社員給与
  - 賃料
  - 水道光熱費
  - 通信費
  - その他固定費
- 営業利益

**入力方式**:
- 各科目に見込み額・実績額を入力
- 小計・合計は自動計算
- ハイライト行の設定可能

**保存機能**:
- 月別に保存
- 既存データは上書き更新

### 4.2 年次損益推移

**ページ**: `/admin/yearly-progress`

**機能概要**:
- 年間損益推移表示
- 月別比較
- 目標達成率

**表示内容**:
- 12ヶ月分の損益データ
- 月別売上推移グラフ
- 累計営業利益
- 予実差異

---

## 5. 支払い管理

### 5.1 支払い履歴管理

**ページ**: `/admin/payments`

**機能概要**:
- 月次支払い履歴管理
- 取引先別支払い記録
- 年間カレンダー表示

**UI構成**:
- 左側: 月別支払いカード表示
- 右側: 取引先一覧サイドバー

**支払いカード表示項目**:
- 取引先名
- 費目カテゴリ
- 支払い種別（定期/不定期/特定月）
- 支払額入力フィールド
- 銀行口座情報（展開表示）

**年間カレンダー**:
- 12ヶ月一覧表示
- 月クリックで切り替え
- 現在月強調表示

**取引先サイドバー**:
- 取引先一覧表示
- 検索機能
- クリックで該当カードにスクロール

**保存機能**:
- 「保存」ボタンで一括保存
- 未保存の変更がある場合、インジケーター表示
- リセットボタンで変更破棄

---

## 6. 店舗管理

### 6.1 店舗一覧・編集

**ページ**: `/admin/stores`

**機能概要**:
- 店舗CRUD操作
- 業態別フィルタリング

**表示項目**:
- 店舗名
- 業態
- 作成日
- 更新日

**操作**:
- 新規作成: モーダルフォーム表示
- 編集: 既存データ読み込み
- 削除: 確認ダイアログ表示

**権限制御**:
- super_admin: 全店舗の作成・編集・削除
- admin: 所属業態の閲覧のみ

---

## 7. 従業員管理

### 7.1 従業員一覧・編集

**ページ**: `/admin/employees`

**機能概要**:
- 従業員CRUD操作
- 店舗別・業態別フィルタリング
- ロール変更

**表示項目**:
- 従業員ID
- 氏名（ニックネーム）
- 所属店舗
- ロール
- 有効/無効ステータス

**操作**:
- 新規作成: フォーム入力
- 編集: データ更新
- 削除: 論理削除（is_active: false）

**権限制御**:
- super_admin: 全従業員管理
- admin: 所属業態の従業員のみ

**フィルタリング**:
- 業態選択（super_adminのみ）
- 店舗選択
- ロール選択
- 有効/無効切り替え

---

## 8. ダッシュボード

### 8.1 管理者ダッシュボード

**ページ**: `/admin/dashboard`

**機能概要**:
- 統計情報表示
- 最新アクティビティ表示
- クイックアクセスリンク

**表示ウィジェット**:
- 店舗数
- 従業員数
- 今月のシフト提出率
- 今月の売上（速報）
- 最新アクティビティ（最新5-20件）

**アクティビティログ**:
- アクション種別（作成/更新/削除）
- リソース種別（従業員/店舗/シフト等）
- 実行者
- 実行日時
- 説明文

**権限別表示**:
- super_admin: 全業態のアクティビティ（最大20件）
- admin: 所属業態のみ（最大10件）

### 8.2 従業員ダッシュボード

**ページ**: `/employee/dashboard`

**機能概要**:
- 個人情報サマリー
- 今月のシフト状況
- お知らせ表示

**表示情報**:
- 個人プロフィール
- 今月のシフト提出状況
- 次回提出期限
- 勤務時間合計

---

## 9. 取引先管理

### 9.1 取引先企業マスタ

**ページ**: `/admin/companies`

**機能概要**:
- 取引先企業情報管理
- 銀行口座情報管理
- 支払い設定

**入力項目**:
- 企業名（必須）
- 銀行名
- 支店名
- 口座種別（普通/当座）
- 口座番号
- 費目カテゴリ
- 支払い種別:
  - 定期: 毎月固定額
  - 不定期: 月により変動
  - 特定月: 指定月のみ
- 定期支払額
- 特定月（配列）
- 表示/非表示フラグ

**操作**:
- 新規作成
- 編集
- 削除（論理削除: is_visible = false）

---

## 10. 業態管理

### 10.1 業態マスタ

**ページ**: `/admin/business-types`

**機能概要**:
- 業態情報管理
- 店舗グルーピング

**現在の業態**:
- Manager: 管理者用特別業態
- Cafe: カフェ・コーヒーショップ
- Fast Food: ファストフード
- Izakaya: 居酒屋・バー
- Ramen: ラーメン店
- Yakiniku: 焼肉店
- 一般: 一般店舗用

**入力項目**:
- 業態名（必須、ユニーク）
- 説明

**操作**:
- 新規作成（super_adminのみ）
- 編集（super_adminのみ）
- 削除（super_adminのみ、関連店舗がない場合のみ）

---

## 共通機能

### エラーハンドリング

すべてのページで統一的なエラー処理:
- ネットワークエラー: 再試行可能なメッセージ
- 認証エラー: ログイン画面にリダイレクト
- 権限エラー: 403ページ表示
- データエラー: 詳細エラーメッセージ表示

### ローディング状態

- データ取得中: スピナー表示
- 保存中: ボタン無効化 + ローディング表示
- ページ遷移中: プログレスバー

### レスポンシブ対応

- デスクトップ: フル機能
- タブレット: 最適化レイアウト
- スマートフォン: 簡易表示

### データバリデーション

- フロントエンド: リアルタイム検証
- バックエンド: 再検証（セキュリティ）
- エラー表示: インラインメッセージ

---

**更新履歴**:
- 2025年1月30日: 初版作成、全機能詳細記載
