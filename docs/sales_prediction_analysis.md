# 売上予測機能の分析レポート

## 概要

`E:\EDWサイト(試作 - コピー\ktg\edw\code\sales` フォルダに存在する売上予測機能の分析結果です。

## システム構成

### 1. データモデル (`models.py`)

**SalesDateモデル** - 日次売上データと天気データを統合管理

#### 主要フィールド

**売上データ:**
- `ohb_sales`: OHB売上（整数）
- `edw_sales`: EDW売上（整数）
- `ohb_customers`: OHB客数（整数）
- `edw_customers`: EDW客数（整数）

**天気データ:**
- `temperature`: 気温（℃）
- `humidity`: 湿度（%）
- `precipitation`: 降水量（mm）
- `snow`: 降雪量（cm）
- `windspeed`: 最大風速（km/h）
- `gust`: 突風（km/h）
- `pressure`: 気圧（hPa）
- `feelslike`: 体感温度（℃）
- `weather`: 天候（文字列: 晴れ、雨、曇りなど）

**日付・カレンダー情報:**
- `date`: 日付（ユニーク）
- `weekday`: 曜日（自動計算: 月、火、水...）
- `is_holiday`: 祝日フラグ（自動判定）
- `holiday_name`: 祝日名（自動取得）

**その他:**
- `items`: ManyToManyField（アイテム販売数との関連）

### 2. 予測エンジン (`sales_predictor.py`)

#### 使用技術
- **機械学習ライブラリ**: LightGBM (LGBMRegressor)
- **データ処理**: pandas, numpy
- **評価指標**: MAE, R2, MAPE

#### 特徴量エンジニアリング

**基本特徴量:**
- 天気データ（気温、湿度、降水量、降雪量、風速、気圧、体感温度）
- 曜日（0-6の数値）
- 祝日フラグ
- 月、日
- 月初・月末フラグ
- 年間通算日

**時系列特徴量:**
- 移動平均（7日、90日）
- ラグ特徴量（7日前、14日前の売上）

**イベント特徴量（定義済み、現在はコメントアウト）:**
- バレンタインデー
- ホワイトデー
- 母の日・父の日
- お盆
- クリスマス
- 卒業シーズン
- 入学・新生活シーズン

#### 予測フロー

1. **データ準備**
   - 過去データから学習用データセットを作成
   - 予測対象期間（今日から7日後まで）のデータを準備

2. **特徴量作成**
   - `make_features()`関数で特徴量を生成
   - One-hotエンコーディングでカテゴリ変数を数値化

3. **モデル学習**
   - EDW売上とOHB売上それぞれに独立したモデルを構築
   - LightGBMを使用

4. **予測実行**
   - 未来7日間の売上を予測
   - 予測値をデータベースに保存

5. **評価・可視化**
   - 学習データに対する精度を評価
   - 特徴量重要度を表示
   - 予測結果をグラフ化して保存

### 3. 天気データ取得

#### 未来の天気データ (`views.py` - `fetch_and_save_weather()`)

**API**: Visual Crossing Weather API
- **期間**: 今日から7日後まで
- **取得データ**: 気温、湿度、降水量、降雪量、風速、突風、気圧、体感温度、天候
- **自動翻訳**: 英語の天候を日本語に変換

#### 過去の天気データ (`past_weather.py`)

**API**: Tomorrow.io API
- **期間**: 過去1年分
- **取得データ**: 平均気温、平均湿度、累積降水量、天候コード

### 4. データインポート機能

#### Excel売上データインポート (`views.py` - `upload_excel()`)

- **対象期間**: 過去20日間
- **データソース**: Excelファイル（24年度シート）
- **取得列**:
  - L列: EDW売上
  - N列: OHB売上
  - AM列: OHB客数
  - Q列 - AM列: EDW客数

#### CSV売上データインポート (`management/commands/csv_sales.py`)

- CSVファイルから売上データを一括インポート
- 既存データは更新、新規データは追加

#### CSV天気データインポート (`management/commands/csv_weather.py`)

- CSVファイルから天気データを一括インポート
- 既存データは更新、新規データは追加

### 5. ビュー・UI (`views.py` - `sales_table()`)

#### 機能
1. **天気データ取得**: 未来7日間の天気を自動取得
2. **売上予測実行**: 予測モデルを実行して未来7日間の売上を予測
3. **データ表示**: 年・月タブで売上データを表示

#### データ処理
- 年・月でグループ化
- 単価計算（売上÷客数）
- イベント名の補完（祝日名が空欄の場合）
- 数値のフォーマット（カンマ区切り）

### 6. シンプルな予測モデル (`predictor.py`)

**使用技術**: scikit-learn LinearRegression
- よりシンプルな線形回帰モデル
- ダミー変数化でカテゴリ変数を処理
- 学習・テストデータの分割（8:2）

## 現在のサイトへの導入検討事項

### 必要な変更・追加

#### 1. データベーススキーマ

**既存の`sales_data`テーブルに追加が必要なカラム:**
- 天気関連カラム（気温、湿度、降水量、降雪量、風速、突風、気圧、体感温度、天候）
- 祝日関連カラム（is_holiday, holiday_name）
- 曜日カラム（weekday）

**または、新しいテーブル`weather_data`を作成:**
- `date` (DATE, PRIMARY KEY)
- 天気関連の全カラム
- `sales_data`テーブルとJOINして使用

#### 2. バックエンドAPI

**必要なエンドポイント:**
- `POST /api/sales/predict`: 売上予測を実行
- `GET /api/sales/predictions`: 予測結果を取得
- `POST /api/weather/fetch`: 天気データを取得・更新
- `GET /api/weather/history`: 過去の天気データを取得

#### 3. 機械学習モデルの実装

**選択肢:**
- **A. Pythonバックエンドを追加**: Django/Flaskで予測APIを実装
- **B. Node.jsで実装**: `ml-matrix`や`ml-regression`などのライブラリを使用（精度は劣る可能性）
- **C. 外部サービス**: 予測処理を別のPythonサービスとして実装し、REST APIで連携

**推奨**: 選択肢AまたはC（Pythonの機械学習ライブラリの豊富さを考慮）

#### 4. フロントエンドUI

**必要な画面:**
- 売上予測ページ（予測結果の表示）
- 予測設定ページ（予測期間、モデルパラメータの調整）
- 予測精度の可視化（グラフ表示）

**使用ライブラリ:**
- Chart.js または Recharts（予測結果のグラフ表示）
- React Query（予測データの取得・キャッシュ）

#### 5. 定期実行タスク

**必要な処理:**
- 毎日自動で天気データを取得
- 毎日自動で売上予測を実行
- 予測結果をデータベースに保存

**実装方法:**
- Node.js: `node-cron`を使用
- Python: Celery + Redis/RabbitMQ
- 外部: GitHub Actions、AWS Lambdaなど

### 技術スタックの違い

| 項目 | 既存システム | 現在のサイト |
|------|------------|------------|
| フレームワーク | Django (Python) | Next.js (TypeScript) |
| バックエンド | Django REST Framework | Express.js (TypeScript) |
| データベース | PostgreSQL (Django ORM) | PostgreSQL (pg) |
| 機械学習 | Python (LightGBM, scikit-learn) | 未実装 |
| 天気API | Visual Crossing, Tomorrow.io | 未実装 |

### 導入時の課題

#### 1. 機械学習モデルの移植
- PythonのLightGBMをNode.jsで直接使用できない
- Pythonバックエンドを追加するか、別サービスとして実装が必要

#### 2. データ構造の違い
- 既存システム: `SalesDate`モデルに売上と天気が統合
- 現在のサイト: `sales_data`と`monthly_sales`に分離、天気データなし

#### 3. 店舗管理の違い
- 既存システム: OHBとEDWの2店舗を想定
- 現在のサイト: 複数店舗を管理（`store_id`で区別）

#### 4. 予測期間の設定
- 既存システム: 固定で7日間先を予測
- 現在のサイト: 柔軟な期間設定が必要かも

### 推奨実装アプローチ

#### アプローチ1: Pythonマイクロサービス（推奨）

1. **Python予測サービスを別途構築**
   - FastAPIまたはFlaskでREST APIを実装
   - LightGBMモデルを実装
   - PostgreSQLからデータを取得
   - 予測結果をPostgreSQLに保存

2. **Node.jsバックエンドから呼び出し**
   - `/api/sales/predict`エンドポイントでPythonサービスを呼び出し
   - 予測結果をフロントエンドに返す

3. **定期実行**
   - Pythonサービスにcronジョブを設定
   - またはNode.jsの`node-cron`からPythonサービスを呼び出し

**メリット:**
- 既存のPythonコードをほぼそのまま使用可能
- 機械学習ライブラリの豊富な選択肢
- 予測処理を独立してスケール可能

**デメリット:**
- システム構成が複雑になる
- Pythonサービスのデプロイ・管理が必要

#### アプローチ2: Node.jsで簡易実装

1. **簡易な予測モデルを実装**
   - 線形回帰や移動平均ベースの予測
   - `ml-regression`などのNode.jsライブラリを使用

2. **特徴量を簡略化**
   - 天気データの一部のみ使用
   - 時系列特徴量を簡略化

**メリット:**
- 既存のNode.jsスタック内で完結
- システム構成がシンプル

**デメリット:**
- 予測精度が低下する可能性
- 既存のPythonコードを活用できない

#### アプローチ3: ハイブリッド（段階的導入）

1. **Phase 1**: 天気データ取得機能を実装
2. **Phase 2**: 簡易な予測モデルをNode.jsで実装
3. **Phase 3**: Pythonマイクロサービスを追加して高精度な予測を実装

## まとめ

### 機能の概要
- **天気データの自動取得**: 未来7日間と過去1年分
- **機械学習による売上予測**: LightGBMを使用した高精度な予測
- **予測結果の可視化**: グラフとテーブルでの表示
- **データインポート**: Excel/CSVからの一括インポート

### 導入の難易度
- **高**: 機械学習モデルの移植が必要
- **中**: データベーススキーマの拡張
- **低**: 天気データ取得APIの実装
- **低**: フロントエンドUIの実装

### 推奨事項
1. **まず天気データ取得機能を実装**して、データを蓄積
2. **簡易な予測モデルを実装**して動作確認
3. **Pythonマイクロサービスを追加**して高精度な予測を実現

### 次のステップ（実装時）
1. データベーススキーマの設計・実装
2. 天気データ取得APIの実装
3. 予測モデルの実装（簡易版またはPythonサービス）
4. フロントエンドUIの実装
5. 定期実行タスクの設定

